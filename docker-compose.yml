services:
  # PostgreSQL moved to server 2 (85.239.44.28)
  # Redis moved to server 2 (85.239.44.28)

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: barsik-backend
    restart: unless-stopped
    environment:
      SERVER_PORT: ${SERVER_PORT:-9001}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400000}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-100MB}
      MAX_REQUEST_SIZE: ${MAX_REQUEST_SIZE:-100MB}
      UPLOAD_DIR: /app/uploads
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:*,http://barsik-frontend:*}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      APP_LOG_LEVEL: ${APP_LOG_LEVEL:-INFO}
      DB_HOST: ${DB_HOST:-85.239.44.28}
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-barsikdb}
      DB_USER: ${DB_USER:-barsik}
      DB_PASSWORD: ${DB_PASSWORD:-barsik}
      DDL_AUTO: ${DDL_AUTO:-update}
      HIKARI_MAX_POOL: ${HIKARI_MAX_POOL:-10}
      JAVA_OPTS: ${JAVA_OPTS:--Xmx512m -Xms256m}
      TURN_SECRET: ${TURN_SECRET:-}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY:-}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY:-}
      VAPID_SUBJECT: ${VAPID_SUBJECT:-mailto:admin@barsik.chat}
    volumes:
      - uploads_data:/app/uploads
    # Port NOT exposed externally â€” only reachable via nginx on barsik-net
    networks:
      - barsik-net
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: "2.0"

  nginx:
    build:
      context: .
      dockerfile: nginx/Dockerfile
    container_name: barsik-nginx
    restart: unless-stopped
    ports:
      - "80:8080"
    depends_on:
      - backend
    networks:
      - barsik-net
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.25"

volumes:
  uploads_data:

networks:
  barsik-net:
    driver: bridge
